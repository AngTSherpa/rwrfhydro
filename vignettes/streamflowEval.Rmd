---
title: "Evaluate streamflow simulation with rwrfhydro"
author: "Aubrey Dugger and James McCreight"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Background
We are using WRF-Hydro to predict streamflow for Fourmile Creek at the Orodell USGS gage for the 2013 snowmelt period. We ran WRF-Hydro with NoahMP as the LSM for a 3-year spinup period and then did an hourly run for 1 month starting May 1, 2013. We want to evaluate model performance in estimating streamflow with and without overland, subsurface, and groundwater routing active.

Load the rwrfhydro package. 
```{r}
library("rwrfhydro")
```

Set a data path to the Fourmile Creek test case.
```{r}
dataPath <- '/Users/adugger/WRF_Hydro/test_cases/Fourmile_Creek'
```


# Import modelled and observed datasets

Model 1: Only channel routing turned on (hourly model run).
```{r}
modStrh.chrt.fc <- ReadFrxstPts(paste0(dataPath, '/RUN.RTTESTS/OUTPUT_CHRT/frxst_pts_out.txt'))
```

Model 2: All WRF-Hydro routing options turned on (hourly model run).
```{r}
modStrh.allrt.fc <- ReadFrxstPts(paste0(dataPath, '/RUN.RTTESTS/OUTPUT_ALLRT/frxst_pts_out.txt'))
```

USGS gage observed data at 5-minute intervals.
```{r}
obsStr5min.fc <- ReadUsgsGage(paste0(dataPath, '/OBS/5min_str_06727500_110401_140810.txt'))
```


# Plot hydrographs 

Compare hydrographs for the full model run.
```{r compHydrographs, fig.width = 12, fig.height = 6, out.width='700', out.height='350'}
PlotFluxCompare(obsStr5min.fc, "q_cms", modStrh.chrt.fc, "q_cms", strDf.mod2=modStrh.allrt.fc, 
     strCol.mod2="q_cms", labelObs="Observed Fourmile Creek at Orodell", 
     labelMod1="Channel Routing Only", labelMod2="All Routing", 
     title="Streamflow: Fourmile Creek")
```

Now limit the plot to the peak May flow period only. The reported stats are updated to the new time period. (Note that the R warning is innocuous because the subset adjusts for timezone, so it's ok that the timezones don't match.)
```{r compHydrographsSnow, fig.width = 12, fig.height = 6, out.width='700', out.height='350'}
PlotFluxCompare(obsStr5min.fc, "q_cms", modStrh.chrt.fc, "q_cms", strDf.mod2=modStrh.allrt.fc, 
     strCol.mod2="q_cms", labelObs="Observed Fourmile Creek at Orodell", 
     labelMod1="Channel Routing Only", labelMod2="All Routing", 
     title="Streamflow: Fourmile Creek", 
     stdate=as.POSIXct("2013-05-08 00:00:00", format="%Y-%m-%d %H:%M:%S", tz="UTC"), 
     enddate=as.POSIXct("2013-05-11 00:00:00", format="%Y-%m-%d %H:%M:%S", tz="UTC"))
```

# Review flow duration curves

<b>NOTE</b>: You generally evaluate flow duration curves and staistics over much longer time periods (e.g., multiple years) than what we demo here. To make the test case more portable, we are only evaluating model output over 1 month only. 

Calculate percent exceedances for flow duration curves. Note that we need to subset the observations to match our model run period (May 2013). Again, the inconsistent time zone warning is OK since POSIX will match the mismatched time zones for us.
```{r}
obsStr5min.May13.fc <- CalcFdc(subset(obsStr5min.fc, POSIXct>=as.POSIXct("2013-05-01", format="%Y-%m-%d", tz="UTC") & POSIXct<=as.POSIXct("2013-05-31", format="%Y-%m-%d", tz="UTC")))
modStrh.chrt.fc <- CalcFdc(modStrh.chrt.fc)
modStrh.allrt.fc <- CalcFdc(modStrh.allrt.fc)
```

Compare how the models are doing predicting flow values that will be exceeded 20% of the time.
First, calculate the fitted spline functions.
```{r}
fdc.obsStr5min.May13.fc <- CalcFdcSpline(obsStr5min.May13.fc)
fdc.modStrh.chrt.fc <- CalcFdcSpline(modStrh.chrt.fc)
fdc.modStrh.allrt.fc <- CalcFdcSpline(modStrh.allrt.fc)
```

Then, evaluate at the 20% exceedance percentage (high flows).
```{r, results='hold'}
fdc.obsStr5min.May13.fc(0.2)
fdc.modStrh.chrt.fc(0.2)
fdc.modStrh.allrt.fc(0.2)
```

Now try the 80% exceedance percentage (low flows).
```{r, results='hold'}
fdc.obsStr5min.May13.fc(0.8)
fdc.modStrh.chrt.fc(0.8)
fdc.modStrh.allrt.fc(0.8)
```

Plot flow duration curves for a more complete picture. This tool will do the date matching for us, so no need to subset the observations.
```{r flowDurationCurves, fig.width = 12, fig.height = 6, out.width='700', out.height='350'}
PlotFdcCompare(obsStr5min.fc, "q_cms", modStrh.chrt.fc, "q_cms", strDf.mod2=modStrh.allrt.fc, 
     strCol.mod2="q_cms", labelObs="Observed Fourmile Creek", 
     labelMod1="Channel Routing Only", labelMod2="All Routing")
```


# Review model performance statistics

Calculate model performance stats (special formatting comands hidden). Again, this tool does the date matching for us.
```{r, results='hide'}
CalcModPerf(modStrh.chrt.fc, obsStr5min.fc)
```

```{r, , results = "asis", echo=FALSE}
library(pander)
pander::pandoc.table(CalcModPerf(modStrh.chrt.fc, obsStr5min.fc),split.table=Inf)
```

```{r, results='hide'}
CalcModPerf(modStrh.allrt.fc, obsStr5min.fc)
```

```{r, , results = "asis", echo=FALSE}
pander::pandoc.table(CalcModPerf(modStrh.allrt.fc, obsStr5min.fc), split.table=Inf)
```

Help on CalcModPerf gives details on the individual statistics returned.
```{r, results='hide'}
<<background='#FF0000'>>
help(CalcModPerf)
```

<div style="border:1px solid; border-radius: 25px; padding: 12px 25px;">
```{r, echo=FALSE}
<<background='#FF0000'>>
library(printr)
help(CalcModPerf)
```
</div>
<br><br>
Calculate flow duration curve performance statistics.
```{r, results='hide'}
CalcFdcPerf(modStrh.allrt.fc, obsStr5min.fc)
```

```{r, , results = "asis", echo=FALSE}
pander::pandoc.table(CalcFdcPerf(modStrh.allrt.fc, obsStr5min.fc),split.table=Inf)
```

Again, help on CalcFdcPerf gives details on the individual statistics returned.
```{r, results='hide' }
help(CalcFdcPerf)
```
<div style="border:1px solid; border-radius: 25px; padding: 12px 25px;">
```{r, echo=FALSE }
help(CalcFdcPerf)
```
</div>