---
title: "Evaluate streamflow simulations over multiple basins with rwrfhydro"
author: "Aubrey Dugger and James McCreight"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Streamflow Evaluation - Multi-Basin}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Background
We are using WRF-Hydro to predict streamflow for multiple basins in the Upper Rio Grande for 2004-2014. We ran WRF-Hydro with NoahMP as the LSM for the 10-year period with hourly output. We want to evaluate model performance at various gage stations in the domain.

Load the rwrfhydro package. 
```{r}
library("rwrfhydro")
```

```{r, echo=FALSE}
options(width = 190)
library(printr)
```

Set a data path to the Fourmile Creek test case.
```{r}
dataPath <- '~/wrfHydroTestCases/Upper_RioGrande/'
```

# Import observed datasets

Import all gage data from data files we downloaded from the CO DWR website. First, we specify where the gage data files live and build a file list.
```{r}
gageDir <- paste0(dataPath, "/OBS/STRFLOW")
fileList <- list.files(gageDir, pattern=glob2rx("*.txt"))
```

Then, we loop through the files and built a single dataframe with all the gage data
```{r}
obsStr <- data.frame()
for (i in 1:length(fileList)) {
  tmp <- ReadCoDwrGage(paste0(gageDir, "/", fileList[i]))
  obsStr <- plyr::rbind.fill(obsStr,tmp)
}
```

We can double-check to make sure we have all of the gages we expect.
```{r}
unique(obsStr$Station)
```

And we can plot hydrographs for any of the gages.
```{r}
with(subset(obsStr, obsStr$Station=="ALATERCO"), plot(POSIXct, q_cms, typ='l', col='blue'))
with(subset(obsStr, obsStr$Station=="SAGSAGCO"), lines(POSIXct, q_cms, col='green'))
legend("topright", c("ALATERCO","SAGSAGCO"), col=c("blue","green"), lty=c(1,1))
```

# Import model results

Calculate basin-averaged LSM water fluxes. The LSM was run at 1km resolution and the high-res hydro grid was 100m resolution, so our aggregation factor is 10. We are going to use R's multi-core capability (make sure  doMC is installed) and run this summary over 8 cores.

We loop through the number of basins modelled.
```{r}
mskDir <- paste0(dataPath, "/DOMAIN/MASKS")
fileList <- list.files(gageDir, pattern=glob2rx("*.nc"))
for (i in 1:6)
modLdasoutWb1h.allrt.fc <- ReadLdasoutWb(paste0(dataPath, '/OUTPUT'), 
                                         paste0(dataPath, '/DOMAIN/Fulldom_hires_hydrofile.nc'), 
                                         mskvar="basn_msk", basid=1, aggfact=10, ncores=8)
```

Calculate basin-averaged routing water fluxes. 
```{r}
modRtout1h.allrt.fc <- ReadRtout(paste0(dataPath, '/RUN.RTTESTS/OUTPUT_ALLRT_DAILY'), 
                                 paste0(dataPath, '/DOMAIN/hydro_OrodellBasin_100m.nc'), 
                                 mskvar="basn_msk", basid=1, ncores=8)
```

Import groundwater outflow model output.
```{r}
modGwout.allrt.fc <- ReadGwOut(paste0(dataPath, '/RUN.RTTESTS/OUTPUT_ALLRT_DAILY/GW_outflow.txt'))
```


# Plot hydrographs 

Compare hydrographs for the full model run.
```{r compHydrographs, fig.width = 12, fig.height = 6, out.width='700', out.height='350'}
PlotFluxCompare(obsStr5min.fc, "q_cms", modStrd.chrt.fc, "q_cms", strDf.mod2=modStrd.allrt.fc, 
     strCol.mod2="q_cms", labelObs="Observed Fourmile Creek at Orodell", 
     labelMod1="Channel Routing Only", labelMod2="All Routing", 
     title="Streamflow: Fourmile Creek")
```

Now limit the plot to the peak May flow period only. The reported stats are updated to the new time period. (Note that the R warning is innocuous because the subset adjusts for timezone, so it's ok that the timezones don't match.)
```{r compHydrographsSnow, fig.width = 12, fig.height = 6, out.width='700', out.height='350'}
PlotFluxCompare(obsStr5min.fc, "q_cms", modStrd.chrt.fc, "q_cms", strDf.mod2=modStrd.allrt.fc, 
     strCol.mod2="q_cms", labelObs="Observed Fourmile Creek at Orodell", 
     labelMod1="Channel Routing Only", labelMod2="All Routing", 
     title="Streamflow: Fourmile Creek", 
     stdate=as.POSIXct("2013-05-01 00:00:00", format="%Y-%m-%d %H:%M:%S", tz="UTC"), 
     enddate=as.POSIXct("2013-05-31 00:00:00", format="%Y-%m-%d %H:%M:%S", tz="UTC"))
```

# Review flow duration curves

<b>NOTE</b>: You generally evaluate flow duration curves and staistics over much longer time periods (e.g., multiple years) than what we demo here. To make the test case more portable, we are only evaluating once-a-day model output over 5 months. 

Calculate percent exceedances for flow duration curves. Note that we need to subset the observations to match our model run output times, and vice versa.
```{r}
obsStr5min.comp.fc <- CalcFdc(subset(obsStr5min.fc, POSIXct %in% c(modStrd.chrt.fc$POSIXct)))
modStrd.chrt.comp.fc <- CalcFdc(subset(modStrd.chrt.fc, POSIXct %in% c(obsStr5min.comp.fc$POSIXct)))
modStrd.allrt.comp.fc <- CalcFdc(subset(modStrd.allrt.fc, POSIXct %in% c(obsStr5min.comp.fc$POSIXct)))
```

Compare how the models are doing predicting flow values that will be exceeded 20% of the time.
First, calculate the fitted spline functions.
```{r}
fdc.obsStr5min.comp.fc <- CalcFdcSpline(obsStr5min.comp.fc)
fdc.modStrd.chrt.comp.fc <- CalcFdcSpline(modStrd.chrt.comp.fc)
fdc.modStrd.allrt.comp.fc <- CalcFdcSpline(modStrd.allrt.comp.fc)
```

Then, evaluate at the 20% exceedance percentage (high flows).
```{r, results='hold'}
fdc.obsStr5min.comp.fc(0.2)
fdc.modStrd.chrt.comp.fc(0.2)
fdc.modStrd.allrt.comp.fc(0.2)
```

Now try the 80% exceedance percentage (low flows).
```{r, results='hold'}
fdc.obsStr5min.comp.fc(0.8)
fdc.modStrd.chrt.comp.fc(0.8)
fdc.modStrd.allrt.comp.fc(0.8)
```

Plot flow duration curves for a more complete picture. This tool will do the date matching for us, so no need to subset the datasets.
```{r flowDurationCurves, fig.width = 12, fig.height = 6, out.width='700', out.height='350'}
PlotFdcCompare(obsStr5min.fc, "q_cms", modStrd.chrt.fc, "q_cms", strDf.mod2=modStrd.allrt.fc, 
     strCol.mod2="q_cms", labelObs="Observed Fourmile Creek", 
     labelMod1="Channel Routing Only", labelMod2="All Routing")
```


# Review model performance statistics

Calculate model performance stats (special formatting comands hidden). Again, this tool does the date matching for us.
```{r, results='hide'}
CalcModPerf(modStrd.chrt.fc, obsStr5min.fc)
```

```{r, , results = "asis", echo=FALSE}
library(pander)
pander::pandoc.table(CalcModPerf(modStrd.chrt.fc, obsStr5min.fc),split.table=Inf)
```

```{r, results='hide'}
CalcModPerf(modStrd.allrt.fc, obsStr5min.fc)
```

```{r, , results = "asis", echo=FALSE}
pander::pandoc.table(CalcModPerf(modStrd.allrt.fc, obsStr5min.fc), split.table=Inf)
```

Help on CalcModPerf gives details on the individual statistics returned.
```{r, results='hide'}
<<background='#FF0000'>>
help(CalcModPerf)
```

<div style="border:1px solid; border-radius: 25px; padding: 12px 25px;">
```{r, echo=FALSE}
<<background='#FF0000'>>
help(CalcModPerf)
```
</div>
<br><br>
Calculate flow duration curve performance statistics.
```{r, results='hide'}
CalcFdcPerf(modStrd.allrt.fc, obsStr5min.fc)
```

```{r, , results = "asis", echo=FALSE}
pander::pandoc.table(CalcFdcPerf(modStrd.allrt.fc, obsStr5min.fc),split.table=Inf)
```

Again, help on CalcFdcPerf gives details on the individual statistics returned.
```{r, results='hide' }
help(CalcFdcPerf)
```
<div style="border:1px solid; border-radius: 25px; padding: 12px 25px;">
```{r, echo=FALSE }
help(CalcFdcPerf)
```
</div>
